<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Geo Alert - MTQQ over WebSockets</title>   
<!-- Bootstrap -->
<link rel="stylesheet" href="vendor/bootstrap/bootstrap.css" >    
    
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->    
    
    
</head>
<body>
<div class="container">
  <h2>Earthquakes - Last Hour</h2>
  
  <div id="status"></div>
  <div id="progress"></div>    
  <div id="quakes"></div>

</div>

  
<script src="vendor/paho/mqttws31.js"></script>
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="vendor/bootstrap/bootstrap.js"></script>

  
<script>
$(document).ready(function(){
 console.log("ready");    

// Create a client instance
var host = "wsquake.ngrok.com";
var port = 80;
client = new Paho.MQTT.Client(host, Number(port), "clientId");

// set callback handlers
client.onConnectionLost = onConnectionLost;
client.onMessageArrived = onMessageArrived;

// connect the client
client.connect({onSuccess:onConnect});


// called when the client connects
function onConnect() {
  // Once a connection has been made, make a subscription and send a message.
  console.log("onConnect");
  client.subscribe("quakes/lasthour");
  
}

// called when the client loses its connection
function onConnectionLost(responseObject) {
  if (responseObject.errorCode !== 0) {
    console.log("onConnectionLost:"+responseObject.errorMessage);
    $('#status').html('Connection has been lost');
    
  }
}

// called when a message arrives
function onMessageArrived(message) {
  //console.log("onMessageArrived:"+message.payloadString);
    data = JSON.parse(message.payloadString);
    console.log(data);
    var html = [];
    $('#progress').html("Updating<br>");
    for(i=0;i < data.quakes.length;i++){
        quake = data.quakes[i];
        console.log("Quake:" + quake);
        html.push(quake.location + "<br>");
        html.push(quake.magnitude + "<br>");
        html.push('<a href="' + quake.url + '">' + quake.url + '</a>');
        html.push('<hr><br>');
        
    }
    $('#quakes').html(html.join(''));
    d = new Date();
    $('#progress').html("Last Updated: " + d  + "<br><br>");
}    

});

</script>
</bod>
</html>